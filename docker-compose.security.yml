# Docker Compose override для добавления функций безопасности
# Использование: docker-compose -f docker-compose.yml -f docker-compose.security.yml up

services:
  nginx:
    cap_add:
      - NET_ADMIN  # Для работы с iptables!!!
    volumes:
      - ./logs:/var/log/nginx
      - ./scripts:/app/scripts:ro

  # Сервис для автоматического бана
  ban_monitor:
    image: alpine:latest
    container_name: katk_ban_monitor
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    network_mode: "service:nginx"  # Использует сетевой стек nginx
    volumes:
      - ./scripts:/app/scripts
      - ./logs:/var/log/nginx
    command: >
      sh -c "
        apk add --no-cache bash iptables grep &&
        /app/scripts/manage_bans.sh init &&
        echo 'Ban monitor запущен. Проверка каждые 60 секунд...' &&
        while true; do
          /app/scripts/auto_ban.sh
          sleep 60
        done
      "
