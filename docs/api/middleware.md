# –ú–æ–¥—É–ª—å: middleware

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å `middleware.py` —Å–æ–¥–µ—Ä–∂–∏—Ç ASGI middleware –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏
- ‚è±Ô∏è –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞
- üîê JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ cookies
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–æ–≤
- üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
- üåê –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞
- ‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- üö® –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–º–µ–Ω—ã —Ç–æ–∫–µ–Ω–æ–≤

## Middleware

### üìä ASGILoggingMiddleware

**–û–ø–∏—Å–∞–Ω–∏–µ:** Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –ò–∑–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞, –ª–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –¥–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã.

**–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** –ü–µ—Ä–≤—ã–π –≤ —Ü–µ–ø–æ—á–∫–µ middleware (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–Ω—å—à–µ –≤—Å–µ—Ö)

**–ö–ª–∞—Å—Å:** `ASGILoggingMiddleware`

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:**
```python
def __init__(self, app: ASGIApp):
    self.app = app
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `app` (ASGIApp): –°–ª–µ–¥—É—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/middleware –≤ —Ü–µ–ø–æ—á–∫–µ

**–ú–µ—Ç–æ–¥ `__call__`:**
```python
async def __call__(self, scope: Scope, receive: Receive, send: Send):
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
```

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ `http` –∏ `websocket`
   - –î—Ä—É–≥–∏–µ —Ç–∏–ø—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –¥–∞–ª—å—à–µ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏

2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞:**
   - –í—ã–∑—ã–≤–∞–µ—Ç `get_client_ip(request)` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ IP
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Forwarded-For` –æ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `request.state.client_ip` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

3. **–ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏:**
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä —á–µ—Ä–µ–∑ `time.perf_counter()`
   - –û–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç `send` –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å—Ç–∞—Ç—É—Å-–∫–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞
   - –í—ã—á–∏—Å–ª—è–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞

4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:**
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ `env.app_mode != 'local'` (–Ω–µ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
   - –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç healthcheck —ç–Ω–¥–ø–æ–∏–Ω—Ç (`/api/v1/public/healthcheck`)
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç: –º–µ—Ç–æ–¥, –ø—É—Ç—å, —Å—Ç–∞—Ç—É—Å-–∫–æ–¥, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
   - –§–æ—Ä–º–∞—Ç: `HTTP POST /api/v1/private/users/login`

5. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:**
   - –ï—Å–ª–∏ `duration > 7.0` —Å–µ–∫—É–Ω–¥ - –ª–æ–≥–∏—Ä—É–µ—Ç WARNING
   - –ü–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–ª—è—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –§–æ—Ä–º–∞—Ç: `–î–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç | 8.5432`

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:**

Middleware –ø–µ—Ä–µ–¥–∞—ë—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤ `log_event()`:
```python
log_event(
    f'HTTP {request.method} {request.url.path}',
    request=request,
    http_status=status_code,
    response_time=round(duration, 4)
)
```

–≠—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ JSON –ª–æ–≥–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ Grafana (—Å–º. `docs/utils/logger.md`).

**–ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤:**

–ö–æ–Ω—Å–æ–ª—å (—Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥):
```
INFO     | D15-03-2024 T10:30:45 | POST /api/v1/private/users/login | core/api/middleware.py: def __call__(): line - 42 - 192.168.1.100 HTTP POST /api/v1/private/users/login
```

JSON —Ñ–∞–π–ª:
```json
{
  "@timestamp": "2024-03-15T10:30:45.123456Z",
  "level": "INFO",
  "message": "HTTP POST /api/v1/private/users/login",
  "method": "POST",
  "url": "/api/v1/private/users/login",
  "ip": "192.168.1.100",
  "http_status": 200,
  "response_time": 0.1234
}
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –í–°–ï–• –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤–∫–ª—é—á–∞—è –ø—É–±–ª–∏—á–Ω—ã–µ)
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã - —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ—Ç
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `finally` –±–ª–æ–∫ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –ü–æ—Ä–æ–≥ 7 —Å–µ–∫—É–Ω–¥ –¥–ª—è "–¥–æ–ª–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤" –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ

---

### üîê AuthUXASGIMiddleware

**–û–ø–∏—Å–∞–Ω–∏–µ:** Middleware –¥–ª—è JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã –∏–∑ cookies, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å—Ç—ë–∫—à–∏–µ access —Ç–æ–∫–µ–Ω—ã, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `request.state` –∏ –∑–∞—â–∏—â–∞–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã.

**–ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** –í—Ç–æ—Ä–æ–π –≤ —Ü–µ–ø–æ—á–∫–µ middleware (–ø–æ—Å–ª–µ ASGILoggingMiddleware)

**–ö–ª–∞—Å—Å:** `AuthUXASGIMiddleware`

**–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä:**
```python
def __init__(self, app: ASGIApp):
    self.app = app
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `app` (ASGIApp): –°–ª–µ–¥—É—é—â–µ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ/middleware –≤ —Ü–µ–ø–æ—á–∫–µ

**–ú–µ—Ç–æ–¥ `__call__`:**
```python
async def __call__(self, scope: Scope, receive: Receive, send: Send):
    # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
```

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∏–ø–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ `http` –∏ `websocket`
   - –î—Ä—É–≥–∏–µ —Ç–∏–ø—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –¥–∞–ª—å—à–µ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
   ```python
   request.state.role = 'student'
   request.state.user_id = 1
   request.state.session_id = '1'
   request.state.building_id = -1
   ```
   - –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –µ—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
   - –î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –æ—Å—Ç–∞—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ allowed_ips (—Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã):**
   - –ï—Å–ª–∏ `request.state.client_ip in env.allowed_ips`:
     - –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
     - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (`/api/v1/server/*`)
     - –î–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ IP –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

4. **–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –ø—É–±–ª–∏—á–Ω—ã—Ö –ø—É—Ç–µ–π:**
   - –ï—Å–ª–∏ –ø—É—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `/api/v1/public`:
     - –ó–∞–ø—Ä–æ—Å –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
     - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è login, healthcheck, timetable –∏ —Ç.–¥.
     - –û—Å—Ç–∞—é—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ `request.state`

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ access —Ç–æ–∫–µ–Ω–∞:**
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ cookie `access_token`
   - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `get_jwt_decode_payload()`
   - **–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (–ø–æ–¥–¥–µ–ª–∞–Ω):**
     - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è CRITICAL: "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–º–µ–Ω—ã access_token"
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 401 Unauthorized
     - –ó–∞–ø—Ä–æ—Å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

6. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è access —Ç–æ–∫–µ–Ω–∞:**
   - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è `exp` (expiration) —Å —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
   - **–ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫:**
     - –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `refresh_token` –∏–∑ cookies
     - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `reissue_aT()` –¥–ª—è –≤—ã–ø—É—Å–∫–∞ –Ω–æ–≤–æ–≥–æ access —Ç–æ–∫–µ–Ω–∞
     - –ù–æ–≤—ã–π —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `request.state.new_a_t`
     - –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π cookie –≤ –æ—Ç–≤–µ—Ç–µ

7. **–ü—Ä–æ–≤–µ—Ä–∫–∞ refresh —Ç–æ–∫–µ–Ω–∞ (–ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏):**
   - **–ï—Å–ª–∏ refresh —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω:**
     - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è CRITICAL: "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–º–µ–Ω—ã refresh_token"
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 401 Unauthorized
     - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ

8. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   ```python
   request.state.user_id = int(access_token['sub'])
   request.state.session_id = access_token['s_id']
   request.state.role = access_token['role']
   request.state.building_id = int(access_token['bid'])
   ```
   - –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤–æ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
   - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–ü–æ–ª—è JWT —Ç–æ–∫–µ–Ω–∞:**

Access token —Å–æ–¥–µ—Ä–∂–∏—Ç:
- `sub` (subject) - user_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `s_id` (session_id) - ID —Å–µ—Å—Å–∏–∏
- `role` - —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (methodist, read_all, student)
- `bid` (building_id) - ID –∫–æ—Ä–ø—É—Å–∞
- `exp` (expiration) - –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- `user_agent` - User-Agent –±—Ä–∞—É–∑–µ—Ä–∞ (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- `ip` - IP –∞–¥—Ä–µ—Å (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤:**

–ü—Ä–æ—Ü–µ—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:
1. Access —Ç–æ–∫–µ–Ω –∏—Å—Ç—ë–∫
2. Middleware –∏–∑–≤–ª–µ–∫–∞–µ—Ç refresh —Ç–æ–∫–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç refresh —Ç–æ–∫–µ–Ω –≤ –ë–î (—Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞?)
4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π access —Ç–æ–∫–µ–Ω
5. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `request.state.new_a_t`
6. –≠–Ω–¥–ø–æ–∏–Ω—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π cookie –≤ –æ—Ç–≤–µ—Ç–µ

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ—Å—à–æ–≤–Ω—ã–π UX - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–º–µ—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**

Middleware –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç –∞—Ç–∞–∫–∏:
- **–ü–æ–¥–º–µ–Ω–∞ access —Ç–æ–∫–µ–Ω–∞:** –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –ø–æ–¥–ø–∏—Å—å, –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π payload
- **–ü–æ–¥–º–µ–Ω–∞ refresh —Ç–æ–∫–µ–Ω–∞:** –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î, —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á—É–∂–∏—Ö —Ç–æ–∫–µ–Ω–æ–≤:** User-agent –∏ IP –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∞—Ç–∞–∫ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º CRITICAL –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- Middleware –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –í–°–ï–• –∑–∞–ø—Ä–æ—Å–æ–≤ (–∫—Ä–æ–º–µ –ø—É–±–ª–∏—á–Ω—ã—Ö)
- –ë–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏—Å—Ç—ë–∫—à–∏–µ —Ç–æ–∫–µ–Ω—ã
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ request.state

Middleware —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –≤ `request.state`, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤–æ –≤—Å–µ—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö:

```python
@router.post("/create")
async def create_ttable(request: Request, db: PgSqlDep):
    # –î–∞–Ω–Ω—ã–µ –∏–∑ AuthUXASGIMiddleware
    user_id = request.state.user_id
    role = request.state.role
    building_id = request.state.building_id
    session_id = request.state.session_id
    
    # –î–∞–Ω–Ω—ã–µ –∏–∑ ASGILoggingMiddleware
    client_ip = request.state.client_ip
    
    # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    ttable_id = await db.ttable.create(building_id, ...)
    log_event(f"Created timetable | user_id: {user_id}", request=request)
    
    return {"ttable_id": ttable_id}
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞

–ï—Å–ª–∏ middleware –æ–±–Ω–æ–≤–∏–ª —Ç–æ–∫–µ–Ω, —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–æ–ª–∂–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π cookie:

```python
@router.get("/protected")
async def protected_endpoint(request: Request, response: Response):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
    if hasattr(request.state, 'new_a_t'):
        response.set_cookie(
            'access_token',
            request.state.new_a_t,
            **AccToken().model_dump()
        )
    
    return {"data": "protected"}
```

–û–¥–Ω–∞–∫–æ, –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞.

### –ü—É–±–ª–∏—á–Ω—ã–µ vs –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

**–ü—É–±–ª–∏—á–Ω—ã–µ** (`/api/v1/public/*`):
- –ù–µ —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- `request.state` —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –ü—Ä–∏–º–µ—Ä—ã: login, healthcheck, timetable/get

**–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ** (`/api/v1/private/*`):
- –¢—Ä–µ–±—É—é—Ç JWT —Ç–æ–∫–µ–Ω –≤ cookies
- `request.state` —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–∏–º–µ—Ä—ã: logout, seances, n8n_ui —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

**–°–µ—Ä–≤–µ—Ä–Ω—ã–µ** (`/api/v1/server/*`):
- –î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å allowed_ips
- –ù–µ —Ç—Ä–µ–±—É—é—Ç JWT —Ç–æ–∫–µ–Ω–æ–≤
- –ü—Ä–∏–º–µ—Ä—ã: sign_up, set_new_passw

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π

Middleware —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–æ–ª—å, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `role_require` dependency:

```python
from core.utils.lite_dependencies import role_require

@router.post("/create", dependencies=[Depends(role_require(Roles.methodist))])
async def create_ttable(request: Request):
    # –¢–æ–ª—å–∫–æ –º–µ—Ç–æ–¥–∏—Å—Ç—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    # role_require –ø—Ä–æ–≤–µ—Ä—è–µ—Ç request.state.role
    pass
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### üåê –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- `time` - –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- `datetime` - –†–∞–±–æ—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
- `starlette.requests.Request` - –û–±—ä–µ–∫—Ç HTTP –∑–∞–ø—Ä–æ—Å–∞
- `starlette.responses.JSONResponse` - JSON –æ—Ç–≤–µ—Ç
- `starlette.types` - –¢–∏–ø—ã ASGI (ASGIApp, Send, Receive, Scope)

### üîó –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥—É–ª–∏

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- `core.config_dir.config.env` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  - `env.app_mode` - –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (prod, local, docker)
  - `env.allowed_ips` - –°–ø–∏—Å–æ–∫ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö IP –¥–ª—è —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–°–ª–æ–π –¥–∞–Ω–Ω—ã—Ö:**
- `core.data.postgre.PgSql` - –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å PostgreSQL
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ refresh —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

**–£—Ç–∏–ª–∏—Ç—ã:**
- `core.utils.anything.get_client_ip` - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ —Å —É—á—ë—Ç–æ–º –ø—Ä–æ–∫—Å–∏
- `core.utils.jwt_factory` - –†–∞–±–æ—Ç–∞ —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏:
  - `get_jwt_decode_payload()` - –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
  - `reissue_aT()` - –í—ã–ø—É—Å–∫ –Ω–æ–≤–æ–≥–æ access —Ç–æ–∫–µ–Ω–∞
- `core.utils.logger.log_event` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 401 Unauthorized - –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π access —Ç–æ–∫–µ–Ω

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–æ–∫–µ–Ω –ø–æ–¥–¥–µ–ª–∞–Ω, –∏–∑–º–µ–Ω—ë–Ω –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—É—é –ø–æ–¥–ø–∏—Å—å

**–û—Ç–≤–µ—Ç:**
```json
{
  "message": "–ù—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"
}
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** CRITICAL - "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–º–µ–Ω—ã access_token"

**–î–µ–π—Å—Ç–≤–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ `/api/v1/public/users/login`

### 401 Unauthorized - –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π refresh —Ç–æ–∫–µ–Ω

**–ü—Ä–∏—á–∏–Ω–∞:** 
- Refresh —Ç–æ–∫–µ–Ω –ø–æ–¥–¥–µ–ª–∞–Ω
- –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (logout)
- –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î

**–û—Ç–≤–µ—Ç:**
```json
{
  "message": "–ù—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"
}
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** CRITICAL - "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–º–µ–Ω—ã refresh_token | s_id: ...; user_id: ..."

**–î–µ–π—Å—Ç–≤–∏–µ:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ

### WARNING - –î–æ–ª–≥–∏–π –∑–∞–ø—Ä–æ—Å

**–ü—Ä–∏—á–∏–Ω–∞:** –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –±–æ–ª–µ–µ 7 —Å–µ–∫—É–Ω–¥

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** WARNING - "–î–æ–ª–≥–∏–π –æ—Ç–≤–µ—Ç | 8.5432"

**–î–µ–π—Å—Ç–≤–∏–µ:** –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

## üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ü–æ—Ä—è–¥–æ–∫ middleware

Middleware –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

1. **ASGILoggingMiddleware** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∏
2. **AuthUXASGIMiddleware** - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
3. –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–≠—Ç–æ –≤–∞–∂–Ω–æ: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –î–û –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã (–≤–∫–ª—é—á–∞—è –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞).

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

Middleware –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤:
- IP –∞–¥—Ä–µ—Å –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ `request.state`
- JWT —Ç–æ–∫–µ–Ω –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–ª—è healthcheck –∏ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

Middleware –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã:
1. **–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ JWT** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è** - –∑–∞—â–∏—Ç–∞ –æ—Ç replay –∞—Ç–∞–∫
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏ –≤ –ë–î** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É–∫—Ä–∞–¥–µ–Ω–Ω—ã—Ö refresh —Ç–æ–∫–µ–Ω–æ–≤
4. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ç–∞–∫** - –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
5. **IP whitelist** - –∑–∞—â–∏—Ç–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

Middleware –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- –ú–µ—Ç—Ä–∏–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (response_time, http_status) ‚Üí Grafana
- –õ–æ–≥–∏ –∞—Ç–∞–∫ (CRITICAL) ‚Üí Elasticsearch ‚Üí Kibana
- –î–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã (WARNING) ‚Üí –∞–ª–µ—Ä—Ç—ã –≤ Grafana

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ `docs/utils/logger.md`.

## üíª –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ middleware –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ

```python
from fastapi import APIRouter, Request
from core.utils.logger import log_event

router = APIRouter()

@router.post("/create")
async def create_resource(request: Request, db: PgSqlDep):
    # –î–∞–Ω–Ω—ã–µ –∏–∑ AuthUXASGIMiddleware
    user_id = request.state.user_id
    role = request.state.role
    building_id = request.state.building_id
    
    # –î–∞–Ω–Ω—ã–µ –∏–∑ ASGILoggingMiddleware
    client_ip = request.state.client_ip
    
    # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
    resource_id = await db.create_resource(
        user_id=user_id,
        building_id=building_id
    )
    
    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    log_event(
        f"Resource created | id: {resource_id}",
        request=request  # IP —É–∂–µ –≤ request.state
    )
    
    return {"resource_id": resource_id}
```

### üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ

```python
from fastapi import APIRouter, Request, HTTPException
from core.utils.anything import Roles

router = APIRouter()

@router.delete("/delete/{resource_id}")
async def delete_resource(resource_id: int, request: Request):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –≤—Ä—É—á–Ω—É—é
    if request.state.role not in [Roles.methodist, 'admin']:
        raise HTTPException(
            status_code=403,
            detail="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"
        )
    
    # –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞
    await db.delete_resource(resource_id)
    return {"success": True}
```

### üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞

```python
from fastapi import APIRouter, Request, Response
from core.schemas.cookie_settings_schema import AccToken

router = APIRouter()

@router.get("/protected")
async def protected_endpoint(request: Request, response: Response):
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π access —Ç–æ–∫–µ–Ω
    if hasattr(request.state, 'new_a_t'):
        # Middleware –æ–±–Ω–æ–≤–∏–ª —Ç–æ–∫–µ–Ω - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π cookie
        response.set_cookie(
            'access_token',
            request.state.new_a_t,
            **AccToken().model_dump()
        )
    
    # –û–±—ã—á–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
    data = await get_protected_data(request.state.user_id)
    return {"data": data}
```

### üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ –∏–∑ middleware

```python
# Middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã
# –ù–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

from core.utils.logger import log_event

@router.post("/heavy-operation")
async def heavy_operation(request: Request):
    import time
    start = time.time()
    
    # –¢—è–∂—ë–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
    result = await perform_heavy_task()
    
    duration = time.time() - start
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    if duration > 5.0:
        log_event(
            f"Heavy operation took {duration:.2f}s",
            request=request,
            level='WARNING',
            operation_time=duration
        )
    
    return {"result": result}
```

### üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```python
# Middleware –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401
# –ù–æ –º–æ–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

// JavaScript –∫–ª–∏–µ–Ω—Ç
async function apiRequest(url, options) {
    const response = await fetch(url, {
        ...options,
        credentials: 'include'  // –û—Ç–ø—Ä–∞–≤–∫–∞ cookies
    });
    
    if (response.status === 401) {
        // –¢–æ–∫–µ–Ω—ã –Ω–µ–≤–∞–ª–∏–¥–Ω—ã - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ login
        window.location.href = '/login';
        return null;
    }
    
    return await response.json();
}
```

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞

### –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É —ç–Ω–¥–ø–æ–∏–Ω—Ç—É

```
1. –ö–ª–∏–µ–Ω—Ç ‚Üí POST /api/v1/private/users/logout
   Cookies: access_token=..., refresh_token=...

2. ASGILoggingMiddleware:
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç IP: 192.168.1.100
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ request.state.client_ip
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä

3. AuthUXASGIMiddleware:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—É—Ç—å: /api/v1/private/* (–Ω–µ –ø—É–±–ª–∏—á–Ω—ã–π)
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç access_token –∏–∑ cookies
   - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω: –≤–∞–ª–∏–¥–µ–Ω ‚úì
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫: –Ω–µ –∏—Å—Ç—ë–∫ ‚úì
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç request.state:
     * user_id = 42
     * role = 'methodist'
     * building_id = 2
     * session_id = '123'

4. –≠–Ω–¥–ø–æ–∏–Ω—Ç logout:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç request.state.user_id –∏ session_id
   - –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é –≤ –ë–î
   - –£–¥–∞–ª—è–µ—Ç cookies
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {"success": true}

5. ASGILoggingMiddleware (finally):
   - –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä: 0.0234s
   - –õ–æ–≥–∏—Ä—É–µ—Ç: "HTTP PUT /api/v1/private/users/logout"
   - –ú–µ—Ç—Ä–∏–∫–∏: http_status=200, response_time=0.0234

6. –ö–ª–∏–µ–Ω—Ç ‚Üê 200 OK
   {"success": true}
```

### –ó–∞–ø—Ä–æ—Å —Å –∏—Å—Ç—ë–∫—à–∏–º access —Ç–æ–∫–µ–Ω–æ–º

```
1. –ö–ª–∏–µ–Ω—Ç ‚Üí GET /api/v1/private/users/seances
   Cookies: access_token=expired, refresh_token=valid

2. ASGILoggingMiddleware:
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç IP –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä

3. AuthUXASGIMiddleware:
   - –î–µ–∫–æ–¥–∏—Ä—É–µ—Ç access_token: –≤–∞–ª–∏–¥–µ–Ω ‚úì
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫: –ò–°–¢–Å–ö ‚úó
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç refresh_token
   - –í—ã–∑—ã–≤–∞–µ—Ç reissue_aT():
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç refresh_token –≤ –ë–î: –≤–∞–ª–∏–¥–µ–Ω ‚úì
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π access_token
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ request.state.new_a_t
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

4. –≠–Ω–¥–ø–æ–∏–Ω—Ç seances:
   - –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

5. Response middleware (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π access_token –≤ cookie

6. ASGILoggingMiddleware:
   - –õ–æ–≥–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å

7. –ö–ª–∏–µ–Ω—Ç ‚Üê 200 OK
   Set-Cookie: access_token=new_token
   {"seances": [...]}
```

### –ó–∞–ø—Ä–æ—Å —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º (–∞—Ç–∞–∫–∞)

```
1. –ö–ª–∏–µ–Ω—Ç ‚Üí POST /api/v1/private/n8n_ui/ttable/create
   Cookies: access_token=fake_token

2. ASGILoggingMiddleware:
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç IP –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Ç–∞–π–º–µ—Ä

3. AuthUXASGIMiddleware:
   - –ü—ã—Ç–∞–µ—Ç—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å access_token
   - get_jwt_decode_payload() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401
   - –õ–æ–≥–∏—Ä—É–µ—Ç CRITICAL: "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–º–µ–Ω—ã access_token"
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 Unauthorized
   - –ë–õ–û–ö–ò–†–£–ï–¢ –∑–∞–ø—Ä–æ—Å (—ç–Ω–¥–ø–æ–∏–Ω—Ç –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è)

4. ASGILoggingMiddleware:
   - –õ–æ–≥–∏—Ä—É–µ—Ç: http_status=401

5. –ö–ª–∏–µ–Ω—Ç ‚Üê 401 Unauthorized
   {"message": "–ù—É–∂–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"}
```
