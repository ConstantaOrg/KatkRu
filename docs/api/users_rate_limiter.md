# üõ°Ô∏è Rate Limiter

## –û–ø–∏—Å–∞–Ω–∏–µ
–ú–æ–¥—É–ª—å –¥–ª—è –∑–∞—â–∏—Ç—ã —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫ –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π. –†–µ–∞–ª–∏–∑—É–µ—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@rate_limit`, –∫–æ—Ç–æ—Ä—ã–π –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP –∞–¥—Ä–µ—Å–∞ –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º –æ–∫–Ω–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Redis –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤ –ø–æ–ø—ã—Ç–æ–∫.

## –§—É–Ω–∫—Ü–∏–∏

### üîí `rate_limit()`
–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É.

**–°–∏–≥–Ω–∞—Ç—É—Ä–∞:**
```python
def rate_limit(max_attempts: int, window_seconds: int)
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `max_attempts` (int) - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
- `window_seconds` (int) - –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä —Ñ—É–Ω–∫—Ü–∏–∏

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
@router.post("/login")
@rate_limit(5, 300)  # 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç
async def login(body: UserLogInSchema, request: Request, db: PgSqlDep):
    # ... –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞
```

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

1. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞:**
   - –ü–æ–ª—É—á–∞–µ—Ç `client_ip` –∏–∑ `request.state.client_ip`
   - IP —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è middleware (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ASGILoggingMiddleware`)

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—á—ë—Ç—á–∏–∫–∞ –≤ Redis:**
   - –ö–ª—é—á: `login_attempts:{client_ip}`
   - –ï—Å–ª–∏ —Å—á—ë—Ç—á–∏–∫ >= `max_attempts`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 429 Too Many Requests

3. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞:**
   - –ï—Å–ª–∏ –ª–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
   - –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å—á—ë—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è (`redis.delete(key)`)

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
   - –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç `HTTPException` —Å –∫–æ–¥–æ–º 401 (–Ω–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞):
     - –°—á—ë—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è (`redis.incr(key)`)
     - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è TTL –Ω–∞ –∫–ª—é—á (`redis.expire(key, window_seconds)`)
   - –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –¥–∞–ª—å—à–µ

**–ò—Å–∫–ª—é—á–µ–Ω–∏—è:**
- `HTTPException(429)` - –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫

## –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞

Rate limiter –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞—Ç–∞–∫–∏ –ø–µ—Ä–µ–±–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π:
- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ —Å –æ–¥–Ω–æ–≥–æ IP
- –ü–æ—Å–ª–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—Ä–µ–º—è `window_seconds`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ

### –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ Redis

**–ü–æ—á–µ–º—É Redis:**
- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å—á—ë—Ç—á–∏–∫–∞–º (in-memory)
- –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TTL (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–π)
- –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (incr, expire)
- –ù–µ –Ω–∞–≥—Ä—É–∂–∞–µ—Ç PostgreSQL

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π:**
```
login_attempts:192.168.1.100 = 3  (TTL: 300 —Å–µ–∫—É–Ω–¥)
login_attempts:192.168.1.101 = 1  (TTL: 300 —Å–µ–∫—É–Ω–¥)
```

### –°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞

**–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ:**
- –°—á—ë—Ç—á–∏–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é (`redis.delete(key)`)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å—Ä–∞–∑—É –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ª–µ–≥–∏—Ç–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ:**
- –°—á—ë—Ç—á–∏–∫ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 1
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è TTL
- –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL –∫–ª—é—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞:
```python
log_event('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç', request=request, level='CRITICAL')
```

- –£—Ä–æ–≤–µ–Ω—å CRITICAL - —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è IP –∞–¥—Ä–µ—Å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞—Ç–∞–∫
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥—É–ª–∏
- `core.data.redis_storage.get_redis_connection` - –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è Redis
- `core.utils.logger.log_event` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π

### –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- `fastapi.HTTPException` - –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è HTTP –æ—à–∏–±–æ–∫
- `functools.wraps` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –¥–µ–∫–æ—Ä–∏—Ä—É–µ–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

### Redis
- –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—â–µ–Ω–Ω—ã–π Redis —Å–µ—Ä–≤–µ—Ä
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–æ–≤ –ø–æ–ø—ã—Ç–æ–∫
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `core/data/redis_storage.py`

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ó–∞—â–∏—Ç–∞ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –≤—Ö–æ–¥–∞
```python
from core.api.users.rate_limiter import rate_limit

@router.post("/login")
@rate_limit(5, 300)  # 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç
async def login(body: UserLogInSchema, request: Request, db: PgSqlDep):
    user = await db.users.select_user(body.email)
    if not user or not encryption.verify(body.passw, user['passw']):
        raise HTTPException(status_code=401, detail="–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å")
    # ... —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–Ω—ã—Ö –ª–∏–º–∏—Ç–æ–≤
```python
# –°—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
@rate_limit(3, 600)  # 3 –ø–æ–ø—ã—Ç–∫–∏ –∑–∞ 10 –º–∏–Ω—É—Ç
async def reset_password(...):
    pass

# –ú—è–≥–∫–∏–π –ª–∏–º–∏—Ç –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
@rate_limit(10, 60)  # 10 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 1 –º–∏–Ω—É—Ç—É
async def search(...):
    pass
```

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ä–∞–±–æ—Ç—ã

**–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
2. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis: login_attempts:192.168.1.100 = 2
3. –õ–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è login()
4. –í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω, —Å—á—ë—Ç—á–∏–∫ —É–¥–∞–ª—è–µ—Ç—Å—è: DEL login_attempts:192.168.1.100
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 200 OK
```

**–ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
2. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis: login_attempts:192.168.1.100 = 2
3. –õ–∏–º–∏—Ç –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è login()
4. –§—É–Ω–∫—Ü–∏—è –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç HTTPException(401)
5. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç 401, —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫: INCR login_attempts:192.168.1.100 ‚Üí 3
6. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç TTL: EXPIRE login_attempts:192.168.1.100 300
7. –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç 401 –∫–ª–∏–µ–Ω—Ç—É
```

**–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞:**
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç 6-—é –ø–æ–ø—ã—Ç–∫—É –≤—Ö–æ–¥–∞
2. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Redis: login_attempts:192.168.1.100 = 5
3. –õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω (5 >= 5)
4. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è CRITICAL —Å–æ–±—ã—Ç–∏–µ
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è HTTPException(429) –±–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
6. –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –º–æ–¥—É–ª—è–º–∏

### –°–≤—è–∑—å —Å users_api.py
–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —ç–Ω–¥–ø–æ–∏–Ω—Ç—É `/login`:
```python
@router.post("/public/users/login")
@rate_limit(5, 300)
async def login(...):
    # ... –ª–æ–≥–∏–∫–∞ –≤—Ö–æ–¥–∞
```

### –°–≤—è–∑—å —Å middleware
–¢—Ä–µ–±—É–µ—Ç `client_ip` –≤ `request.state`:
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ `ASGILoggingMiddleware`
- –ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (X-Forwarded-For, X-Real-IP)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞

### –°–≤—è–∑—å —Å Redis
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `get_redis_connection()`:
```python
async with get_redis_connection() as redis:
    await redis.get(key)
    await redis.incr(key)
    await redis.expire(key, ttl)
    await redis.delete(key)
```

### –°–≤—è–∑—å —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ Elasticsearch:
- –£—Ä–æ–≤–µ–Ω—å CRITICAL –¥–ª—è –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–∞
- –í–∫–ª—é—á–∞–µ—Ç IP –∞–¥—Ä–µ—Å –∏ –¥–µ—Ç–∞–ª–∏ –∑–∞–ø—Ä–æ—Å–∞
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—Ç–∞–∫–∏ –≤ Grafana

## –¢–∏–ø–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–õ–µ–≥–∏—Ç–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±—ã–ª –ø–∞—Ä–æ–ª—å:**
   - –î–µ–ª–∞–µ—Ç 3 –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
   - –í—Å–ø–æ–º–∏–Ω–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
   - 4-—è –ø–æ–ø—ã—Ç–∫–∞ —É—Å–ø–µ—à–Ω–∞, —Å—á—ë—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
   - –ú–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç—É –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

2. **–ë—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫–∞:**
   - –ê—Ç–∞–∫—É—é—â–∏–π –¥–µ–ª–∞–µ—Ç 5 –ø–æ–ø—ã—Ç–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–æ–ª—è–º–∏
   - 6-—è –ø–æ–ø—ã—Ç–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è —Å 429 –æ—à–∏–±–∫–æ–π
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è CRITICAL —Å–æ–±—ã—Ç–∏–µ
   - –ê—Ç–∞–∫—É—é—â–∏–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –Ω–∞ 5 –º–∏–Ω—É—Ç
   - –ü–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL –º–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞ (–Ω–æ —Å–Ω–æ–≤–∞ –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)

3. **–†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –∞—Ç–∞–∫–∞:**
   - –ê—Ç–∞–∫—É—é—â–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞–∑–Ω—ã–µ IP –∞–¥—Ä–µ—Å–∞
   - –ö–∞–∂–¥—ã–π IP –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫
   - –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ CRITICAL —Å–æ–±—ã—Ç–∏–π —Å —Ä–∞–∑–Ω—ã—Ö IP
   - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å IP –Ω–∞ —É—Ä–æ–≤–Ω–µ firewall

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–±—Ö–æ–¥–∞

**IP spoofing:**
- –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `request.state.client_ip`
- IP –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è middleware —Å —É—á—ë—Ç–æ–º –ø—Ä–æ–∫—Å–∏ (X-Forwarded-For)
- –°–ª–æ–∂–Ω–æ –ø–æ–¥–¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ

**–°–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–∞:**
- –°—á—ë—Ç—á–∏–∫ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ (200 OK)
- –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Å–µ–≥–¥–∞ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Å—á—ë—Ç—á–∏–∫
- –ù–µ–ª—å–∑—è –æ–±–æ–π—Ç–∏, –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞—è —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –¥—Ä—É–≥–∏–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º

**TTL –≤ Redis:**
- –ö–ª—é—á–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É

### –£—Ä–æ–≤–Ω–∏ –∑–∞—â–∏—Ç—ã

1. **Application level** (—ç—Ç–æ—Ç –º–æ–¥—É–ª—å):
   - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

2. **Network level** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):
   - Firewall rules –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ IP
   - DDoS protection
   - Rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ nginx/load balancer

3. **Database level**:
   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ—Å–ª–µ N –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
   - –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ CAPTCHA –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—à–∏–±–æ–∫

## –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **–û–±—â–∏–π IP –∞–¥—Ä–µ—Å:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞ NAT –∏–º–µ—é—Ç –æ–¥–∏–Ω –≤–Ω–µ—à–Ω–∏–π IP
   - –û–¥–∏–Ω –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ—Ö
   - –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fingerprinting –∏–ª–∏ CAPTCHA

2. **–†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏:**
   - –ê—Ç–∞–∫—É—é—â–∏–π —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º IP –º–æ–∂–µ—Ç –æ–±–æ–π—Ç–∏ –ª–∏–º–∏—Ç
   - –†–µ—à–µ–Ω–∏–µ: –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ç–∏

3. **Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:**
   - –ï—Å–ª–∏ Redis —É–ø–∞–ª, –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
   - –≠–Ω–¥–ø–æ–∏–Ω—Ç —Å—Ç–∞–Ω–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
   - –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å fallback –∏–ª–∏ circuit breaker


## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ª–∏–º–∏—Ç—ã:**
   - –†–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –¥–ª—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö IP

2. **Whitelist/Blacklist:**
   - –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö IP
   - –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∞—Ç–∞–∫—É—é—â–∏—Ö

3. **CAPTCHA –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - –¢—Ä–µ–±–æ–≤–∞—Ç—å CAPTCHA –ø–æ—Å–ª–µ 3 –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞—Ç–∞–∫–∏

4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - Email/SMS –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –∞–∫–∫–∞—É–Ω—Ç–∞
   - –ê–ª–µ—Ä—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –∞—Ç–∞–∫–∞—Ö

5. **Graceful degradation:**
   - Fallback –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏

6. **–ú–µ—Ç—Ä–∏–∫–∏:**
   - –°—á—ë—Ç—á–∏–∫–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ì—Ä–∞—Ñ–∏–∫–∏ –∞—Ç–∞–∫ –≤ Grafana
   - –ê–Ω–∞–ª–∏–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞—Ç–∞–∫

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–î–ª—è —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ `/login`:
```python
@rate_limit(5, 300)  # 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥)
```

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
- –í—Ö–æ–¥: 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç
- –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è: 3 –ø–æ–ø—ã—Ç–∫–∏ –∑–∞ 10 –º–∏–Ω—É—Ç
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è: 3 –ø–æ–ø—ã—Ç–∫–∏ –∑–∞ 1 —á–∞—Å

**–î–ª—è –æ–±—ã—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
- –ü–æ–∏—Å–∫: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 1 –º–∏–Ω—É—Ç—É
- API –∑–∞–ø—Ä–æ—Å—ã: 1000 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 1 —á–∞—Å

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Redis

–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ `core/data/redis_storage.py`:
```python
REDIS_HOST = "localhost"
REDIS_PORT = 6379
REDIS_DB = 0
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏

–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è:
```
[CRITICAL] –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç | ip: 192.168.1.100
```

### –ú–µ—Ç—Ä–∏–∫–∏ –≤ Redis

–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–∫—É—â–∏—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤:
```bash
redis-cli KEYS "login_attempts:*"
redis-cli GET "login_attempts:192.168.1.100"
redis-cli TTL "login_attempts:192.168.1.100"
```

### Grafana –¥–∞—à–±–æ—Ä–¥—ã

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (429) –∑–∞ –ø–µ—Ä–∏–æ–¥
- Top IP –∞–¥—Ä–µ—Å–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫
- –ì—Ä–∞—Ñ–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ (—É—Å–ø–µ—à–Ω—ã—Ö vs –Ω–µ—É–¥–∞—á–Ω—ã—Ö)
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

## –°–≤—è–∑—å —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –¥–æ–ø–æ–ª–Ω—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:
- `docs/api/users_api.md` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ `/login`
- `docs/utils/logger.md` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
- `docs/api/middleware.md` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ `client_ip` –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
