# –ú–æ–¥—É–ª—å: users_api

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å `users_api.py` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –≤ —Å–∏—Å—Ç–µ–º–µ. –í–∫–ª—é—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –≤—Ö–æ–¥–∞, –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏ –∏ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîê –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ email –∏ –ø–∞—Ä–æ–ª—å
- üç™ JWT —Ç–æ–∫–µ–Ω—ã –≤ HTTP-only cookies
- üö™ –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ —Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏
- üì± –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (—Å–µ—Å—Å–∏–π)
- üîÑ –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
- üõ°Ô∏è Rate limiting –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞
- üîí –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### ‚úçÔ∏è POST /api/v1/server/users/sign_up

**–û–ø–∏—Å–∞–Ω–∏–µ:** –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ. –°–æ–∑–¥–∞—ë—Ç —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º –∏ –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –∫–æ—Ä–ø—É—Å—É (building). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ä–æ–ª—å `methodist`.

**Middleware:** –ù–µ—Ç (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:** –ù–µ—Ç

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "email": "user@example.com",
  "passw": "SecurePassword123",
  "name": "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤",
  "building_id": 1
}
```

–ü–æ–ª—è:
- `email` (str): Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
- `passw` (str): –ü–∞—Ä–æ–ª—å (–±—É–¥–µ—Ç –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω)
- `name` (str): –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `building_id` (int): ID –∫–æ—Ä–ø—É—Å–∞ (1, 2 –∏–ª–∏ 3)

**–†–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:**
- –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ä–æ–ª—å `methodist` –≤ –ë–î
- –†–æ–ª—å –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ API, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**–û—Ç–≤–µ—Ç (200) - –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:**
```json
{
  "success": true,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω"
}
```

**–û—Ç–≤–µ—Ç (409) - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:**
```json
{
  "success": false,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
  "detail": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
}
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `db.users.reg_user()` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- `hide_log_param()` - –°–∫—Ä—ã—Ç–∏–µ —á–∞—Å—Ç–∏ email –≤ –ª–æ–≥–∞—Ö (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
- `log_event()` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `create_user_registration_response()` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- `create_response_json()` - –°–æ–∑–¥–∞–Ω–∏–µ JSON –æ—Ç–≤–µ—Ç–∞ —Å —Å—Ç–∞—Ç—É—Å-–∫–æ–¥–æ–º

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. –ü–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
2. –ï—Å–ª–∏ email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å —á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã—Ç—ã–º email
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 409 Conflict
3. –ï—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 200 OK
4. –ü–∞—Ä–æ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ `db.users.reg_user()`
5. –ù–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ä–æ–ª—å `methodist` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î)

---

### üîì POST /api/v1/public/users/login

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç email –∏ –ø–∞—Ä–æ–ª—å, —Å–æ–∑–¥–∞—ë—Ç JWT —Ç–æ–∫–µ–Ω—ã –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏—Ö –≤ HTTP-only cookies. –ó–∞—â–∏—â—ë–Ω rate limiter'–æ–º –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞.

**Middleware:** 
- `@rate_limit(5, 300)` - –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ –∑–∞ 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:** –ù–µ—Ç

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "email": "user@example.com",
  "passw": "SecurePassword123"
}
```

–ü–æ–ª—è:
- `email` (str): Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `passw` (str): –ü–∞—Ä–æ–ª—å

**–û—Ç–≤–µ—Ç (200) - –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:**
```json
{
  "success": true,
  "message": "–ö—É–∫–∏ —É –Æ–∑–µ—Ä–∞"
}
```

Cookies (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
- `access_token` - JWT —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ (–∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏)
- `refresh_token` - JWT —Ç–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–¥–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏)

**–û—Ç–≤–µ—Ç (401) - –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```json
{
  "success": false,
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å",
  "detail": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å. –ï—Å–ª–∏ –≤—ã –≤—Ö–æ–¥–∏–ª–∏ —á–µ—Ä–µ–∑ Google/Github –∏ —Ç.–ø. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å"
}
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `db.users.select_user()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
- `encryption.verify()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ö–µ—à–µ–º)
- `issue_aT_rT()` - –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—ã access –∏ refresh —Ç–æ–∫–µ–Ω–æ–≤
- `hide_log_param()` - –°–∫—Ä—ã—Ç–∏–µ —á–∞—Å—Ç–∏ email –≤ –ª–æ–≥–∞—Ö
- `log_event()` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞/–Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
- `create_user_login_response()` - –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- `create_response_json()` - –°–æ–∑–¥–∞–Ω–∏–µ JSON –æ—Ç–≤–µ—Ç–∞
- `response.set_cookie()` - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HTTP-only cookies

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î** –ø–æ email
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è:**
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –ò –ø–∞—Ä–æ–ª—å –≤–µ—Ä–µ–Ω:
     - –°–æ–∑–¥–∞—ë—Ç—Å—è payload –¥–ª—è JWT —Å –¥–∞–Ω–Ω—ã–º–∏: user_id, role, building_id, user_agent, IP
     - –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è access –∏ refresh —Ç–æ–∫–µ–Ω—ã
     - –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î (—Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–µ—Å—Å–∏—è)
     - –¢–æ–∫–µ–Ω—ã —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ HTTP-only cookies
     - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 200 OK
   - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –ò–õ–ò –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω:
     - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Å —á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã—Ç—ã–º email
     - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è 401 Unauthorized

3. **Rate limiting:**
   - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä `@rate_limit(5, 300)` –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `core/api/users/rate_limiter.py`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- Cookies —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∏–∑ `AccToken()` –∏ `RtToken()` (httponly, secure, samesite)
- User-agent –∏ IP —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–æ–∫–µ–Ω–µ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –î–µ—Ç–∞–ª–∏ —Å–µ—Å—Å–∏–∏ (user_agent, IP) –ø–æ–∑–≤–æ–ª—è—é—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### üö™ PUT /api/v1/private/users/logout

**–û–ø–∏—Å–∞–Ω–∏–µ:** –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞. –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –≤ –ë–î –∏ —É–¥–∞–ª—è–µ—Ç JWT —Ç–æ–∫–µ–Ω—ã –∏–∑ cookies.

**Middleware:**
- `JWTCookieDep` - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT cookie

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:** –ù–µ—Ç

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:** –ù–µ—Ç

**–û—Ç–≤–µ—Ç (200):**
```json
{
  "success": true,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞"
}
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `db.auth.session_termination()` - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ –ë–î
- `response.delete_cookie()` - –£–¥–∞–ª–µ–Ω–∏–µ cookies
- `log_event()` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–∞

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è `user_id` –∏ `session_id` –∏–∑ `request.state` (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã JWT middleware)
2. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `db.auth.session_termination()` –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –≤ –ë–î
3. –£–¥–∞–ª—è—é—Ç—Å—è cookies `access_token` –∏ `refresh_token`
4. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –≤—ã—Ö–æ–¥–∞ —Å user_id –∏ session_id
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –≤ –ë–î –¥–µ–ª–∞–µ—Ç refresh token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º
- –£–¥–∞–ª–µ–Ω–∏–µ cookies –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤

---

### üì± POST /api/v1/private/users/seances

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π (—É—Å—Ç—Ä–æ–π—Å—Ç–≤) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å –∫–∞–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –∫–æ–≥–¥–∞ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥.

**Middleware:**
- `JWTCookieDep` - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ JWT cookie

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:** –ù–µ—Ç

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:** –ù–µ—Ç

**–û—Ç–≤–µ—Ç (200):**
```json
{
  "seances": [
    {
      "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)...",
      "ip": "192.168.1.100",
    },
    {
      "user_agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0...)...",
      "ip": "192.168.1.101",
    }
  ]
}
```

–ü–æ–ª—è —Å–µ—Å—Å–∏–∏ –≤ `sessions_users`:
- `session_id` (int): ID —Å–µ—Å—Å–∏–∏
- `user_id`
- `iat` - –∫–æ–≥–¥–∞ –≤—ã–ø—É—â–µ–Ω
- `exp` - –∫–æ–≥–¥–∞ –∏—Å—Ç—ë—á—ë—Ç
- `refresh_token` - —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ refresh_token –≤ JWT –≤–∞—Ä–∏–∞–Ω—Ç–µ
- `user_agent` (str): User-Agent –±—Ä–∞—É–∑–µ—Ä–∞/—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `ip` (str): IP –∞–¥—Ä–µ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `created_at` (datetime): –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ (–≤—Ö–æ–¥–∞)

`is_current` (bool): –Ø–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–µ–π(–≤—ã—è—Å–Ω—è–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ). –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö 200 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏ –æ—Ç–≤–µ—Ç–µ –∏–∑ —Ä—É—á–∫–∏

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `db.auth.all_seances_user()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `log_event()` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. –ò–∑–≤–ª–µ–∫–∞—é—Ç—Å—è `user_id` –∏ `session_id` –∏–∑ `request.state`
2. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
3. –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è –ø–æ–º–µ—á–∞–µ—Ç—Å—è —Ñ–ª–∞–≥–æ–º `is_current = true`
4. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å —Å user_id –∏ session_id
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–∏–¥–µ—Ç—å, —Å –∫–∞–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥
- –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- User-agent –ø–æ–º–æ–≥–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–ü–ö, —Ç–µ–ª–µ—Ñ–æ–Ω, –ø–ª–∞–Ω—à–µ—Ç)
- –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á—É–∂–∏—Ö —Å–µ—Å—Å–∏–π

---

### üîÑ PUT /api/v1/server/users/passw/set_new_passw

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –•–µ—à–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –≤ –ë–î. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º CRITICAL.

**Middleware:** –ù–µ—Ç (—Å–µ—Ä–≤–µ—Ä–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç)

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:** –ù–µ—Ç

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "user_id": 42,
  "passw": "NewSecurePassword456"
}
```

–ü–æ–ª—è:
- `user_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `passw` (str): –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–±—É–¥–µ—Ç –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω)

**–û—Ç–≤–µ—Ç (200):**
```json
{
  "success": true,
  "message": "–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!"
}
```

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `encryption.hash()` - –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
- `db.users.set_new_passw()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –≤ –ë–î
- `log_event()` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É—Ä–æ–≤–Ω–µ–º CRITICAL

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å —Ö–µ—à–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `encryption.hash()`
2. –•–µ—à —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ user_id
3. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è —Å —É—Ä–æ–≤–Ω–µ–º CRITICAL
4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –≠–Ω–¥–ø–æ–∏–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `/server/` –ø—É—Ç–∏ - –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º CRITICAL, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤—ã–∑–æ–≤)
- –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ email
- –ü–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π)

---

## –§—É–Ω–∫—Ü–∏–∏

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (route handlers), –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç. –í—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ –≤—ã–∑–æ–≤—ã –º–µ—Ç–æ–¥–æ–≤ —Å–ª–æ—è –¥–∞–Ω–Ω—ã—Ö (`db.*`) –∏ —É—Ç–∏–ª–∏—Ç.

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### üåê –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- `fastapi` - –§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è API
  - `APIRouter` - –†–æ—É—Ç–µ—Ä –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
  - `Response` - –û–±—ä–µ–∫—Ç HTTP –æ—Ç–≤–µ—Ç–∞
  - `Request` - –û–±—ä–µ–∫—Ç HTTP –∑–∞–ø—Ä–æ—Å–∞

### üîó –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥—É–ª–∏

**–°–ª–æ–π –¥–∞–Ω–Ω—ã—Ö:**
- `core.data.postgre.PgSqlDep` - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ PostgreSQL
  - `db.users.reg_user()` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  - `db.users.select_user()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email
  - `db.users.set_new_passw()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
  - `db.auth.session_termination()` - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
  - `db.auth.all_seances_user()` - –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
- `core.config_dir.config.encryption` - –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª–µ–π
  - `encryption.hash()` - –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è
  - `encryption.verify()` - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è —Å —Ö–µ—à–µ–º

**–°—Ö–µ–º—ã –∑–∞–ø—Ä–æ—Å–æ–≤:**
- `core.schemas.users_schema` - –°—Ö–µ–º—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:
  - `UserRegSchema` - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (email, passw, name, building_id)
  - `UserLogInSchema` - –í—Ö–æ–¥ (email, passw)
  - `UpdatePasswSchema` - –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (user_id, passw)
  - `TokenPayloadSchema` - Payload –¥–ª—è JWT —Ç–æ–∫–µ–Ω–∞

**–°—Ö–µ–º—ã cookies:**
- `core.schemas.cookie_settings_schema` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ JWT cookies:
  - `AccToken` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ access token cookie
  - `RtToken` - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ refresh token cookie
  - `JWTCookieDep` - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT –∏–∑ cookie

**–£—Ç–∏–ª–∏—Ç—ã:**
- `core.utils.jwt_factory.issue_aT_rT` - –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—ã JWT —Ç–æ–∫–µ–Ω–æ–≤
- `core.utils.logger.log_event` - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
- `core.utils.anything.hide_log_param` - –°–∫—Ä—ã—Ç–∏–µ —á–∞—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤ –ª–æ–≥–∞—Ö
- `core.utils.response_model_utils` - –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤:
  - `UserRegistrationSuccessResponse` - –£—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  - `UserRegistrationConflictResponse` - –ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  - `UserLoginSuccessResponse` - –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
  - `UserLoginUnauthorizedResponse` - –ù–µ—É–¥–∞—á–Ω—ã–π –≤—Ö–æ–¥
  - `create_user_registration_response()` - –§–∞–±—Ä–∏–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
  - `create_user_login_response()` - –§–∞–±—Ä–∏–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤—Ö–æ–¥–∞
  - `create_response_json()` - –°–æ–∑–¥–∞–Ω–∏–µ JSON –æ—Ç–≤–µ—Ç–∞

**Middleware:**
- `core.api.users.rate_limiter.rate_limit` - –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π

–í—Å–µ –ø–∞—Ä–æ–ª–∏ —Ö–µ—à–∏—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `encryption.hash()` (argon2)
- –ü–∞—Ä–æ–ª–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `encryption.verify()` - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ö–µ—à–µ–º

### HTTP-only Cookies

JWT —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ HTTP-only cookies:
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è JavaScript (–∑–∞—â–∏—Ç–∞ –æ—Ç XSS)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏: `httponly=True`, `secure=True` (—Ç–æ–ª—å–∫–æ HTTPS), `samesite='lax'`

### Rate Limiting

–≠–Ω–¥–ø–æ–∏–Ω—Ç `/api/v1/public/users/login` –∑–∞—â–∏—â—ë–Ω –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞:
- –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 5 –º–∏–Ω—É—Ç
- –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `@rate_limit(5, 300)`
- –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ `core/api/users/rate_limiter.py`

### –°–∫—Ä—ã—Ç–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö

Email –∞–¥—Ä–µ—Å–∞ —á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö:
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `hide_log_param(email)`
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü: `use***@exa***.com`
- –ó–∞—â–∏—Ç–∞ –æ—Ç —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ª–æ–≥–∏

### –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π

–ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É:
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è User-Agent –∏ IP –∞–¥—Ä–µ—Å
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 409 Conflict - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /server/users/sign_up`

**–ü—Ä–∏—á–∏–Ω–∞:** Email —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": false,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
  "detail": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
}
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** WARNING —Å —á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã—Ç—ã–º email

### 401 Unauthorized - –ù–µ–≤–µ—Ä–Ω—ã–µ —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /api/v1/public/users/login`

**–ü—Ä–∏—á–∏–Ω—ã:**
- Email –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î
- –ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ö–µ—à–µ–º

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": false,
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å",
  "detail": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å. –ï—Å–ª–∏ –≤—ã –≤—Ö–æ–¥–∏–ª–∏ —á–µ—Ä–µ–∑ Google/Github –∏ —Ç.–ø. –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å"
}
```

**–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** WARNING —Å —á–∞—Å—Ç–∏—á–Ω–æ —Å–∫—Ä—ã—Ç—ã–º email

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –¥–ª—è –æ–±–æ–∏—Ö —Å–ª—É—á–∞–µ–≤ (email –Ω–µ –Ω–∞–π–¥–µ–Ω / –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω) - —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ email –≤ —Å–∏—Å—Ç–µ–º–µ.

### 429 Too Many Requests - Rate Limit

**–≠–Ω–¥–ø–æ–∏–Ω—Ç:** `POST /api/v1/public/users/login`

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞ (5 –∑–∞ 5 –º–∏–Ω—É—Ç)

**–û—Ç–≤–µ—Ç:** –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ rate_limiter

**–ó–∞—â–∏—Ç–∞:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫–∏ –Ω–∞ –ø–∞—Ä–æ–ª–∏

## üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ü—É—Ç–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏–º–µ—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å `/api/v1` (–Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ `main_router`).

–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ —É—Ä–æ–≤–Ω—è–º –¥–æ—Å—Ç—É–ø–∞:
- `/api/v1/public/users/*` - –ü—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (login)
- `/api/v1/private/users/*` - –¢—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (logout, seances)
- `/api/v1/server/users/*` - –°–µ—Ä–≤–µ—Ä–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (sign_up, set_new_passw)

### JWT —Ç–æ–∫–µ–Ω—ã

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞—Ä—É —Ç–æ–∫–µ–Ω–æ–≤:
- **Access Token** - –∫–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API
- **Refresh Token** - –¥–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è access token

–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ `core/utils/jwt_factory.py`

### –°–µ—Å—Å–∏–∏ vs –¢–æ–∫–µ–Ω—ã

- **–°–µ—Å—Å–∏—è** - –∑–∞–ø–∏—Å—å –≤ –ë–î —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (user_agent, IP, –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è)
- **–¢–æ–∫–µ–Ω** - JWT, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π session_id –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –≤ –ë–î, –¥–µ–ª–∞—è refresh token –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º CRITICAL:
```python
log_event(f"–Æ–∑–µ—Ä —Å–º–µ–Ω–∏–ª –ü–∞—Ä–æ–ª—å | user_id: {update_secrets.user_id}", request=request, level='CRITICAL')
```

–≠—Ç–æ –≤–∞–∂–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ç—Ä–µ–±—É—é—â–∞—è –æ—Å–æ–±–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è –ø—Ä–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ.

## üíª –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
POST /api/v1/server/users/sign_up
Content-Type: application/json

{
  "email": "methodist@college.edu",
  "passw": "SecurePassword123!",
  "name": "–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞",
  "building_id": 2
}

# –û—Ç–≤–µ—Ç (200):
{
  "success": true,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω"
}

# –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ä–æ–ª—å "methodist" –≤ –ë–î
```

### üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É

```python
POST /api/v1/public/users/login
Content-Type: application/json

{
  "email": "methodist@college.edu",
  "passw": "SecurePassword123!"
}

# –û—Ç–≤–µ—Ç (200):
{
  "success": true,
  "message": "–ö—É–∫–∏ —É –Æ–∑–µ—Ä–∞"
}

# Cookies —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
# - access_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
# - refresh_token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### üì± –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

```python
POST /api/v1/private/users/seances
Cookie: access_token=...; refresh_token=...

# –û—Ç–≤–µ—Ç (200):
{
  "seances": [
    {
      "user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0",
      "ip": "192.168.1.50",
    },
    {
      "user_agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0) Safari/604.1",
      "ip": "192.168.1.51",
    }
  ]
}
```

### üö™ –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞

```python
PUT /api/v1/private/users/logout
Cookie: access_token=...; refresh_token=...

# –û—Ç–≤–µ—Ç (200):
{
  "success": true,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–µ –∞–∫–∫–∞—É–Ω—Ç–∞"
}

# Cookies —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### üîÑ –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è

```python
PUT /api/v1/server/users/passw/set_new_passw
Content-Type: application/json

{
  "user_id": 42,
  "passw": "NewSecurePassword456!"
}

# –û—Ç–≤–µ—Ç (200):
{
  "success": true,
  "message": "–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!"
}
```

### ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```python
# –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º email
POST /api/v1/server/users/sign_up
{
  "email": "existing@college.edu",
  "passw": "password",
  "name": "Test User",
  "building_id": 1
}

# –û—Ç–≤–µ—Ç (409):
{
  "success": false,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
  "detail": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
}

# –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —Å –Ω–µ–≤–µ—Ä–Ω—ã–º –ø–∞—Ä–æ–ª–µ–º
POST /api/v1/public/users/login
{
  "email": "user@college.edu",
  "passw": "WrongPassword"
}

# –û—Ç–≤–µ—Ç (401):
{
  "success": false,
  "message": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å",
  "detail": "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å"
}
```
