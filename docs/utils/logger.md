# –£—Ç–∏–ª–∏—Ç–∞: logger

## –û–ø–∏—Å–∞–Ω–∏–µ

–ú–æ–¥—É–ª—å `logger.py` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –≤—ã–≤–æ–¥–∞:
- **–¶–≤–µ—Ç–Ω–æ–π –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥** - –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏
- **JSON —Ñ–æ—Ä–º–∞—Ç –≤ —Ñ–∞–π–ª—ã** - –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (EFK Stack + Grafana)

–ú–æ–¥—É–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–∑–æ–≤–∞ (—Ñ–∞–π–ª, —Ñ—É–Ω–∫—Ü–∏—è, —Å—Ç—Ä–æ–∫–∞) –∏ –æ–±–æ–≥–∞—â–∞–µ—Ç –ª–æ–≥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ HTTP –∑–∞–ø—Ä–æ—Å–∞—Ö, —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–∑–æ–≤–∞ —á–µ—Ä–µ–∑ `inspect`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —á—Ç–µ–Ω–∏—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
- JSON —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Elasticsearch, Filebeat –∏ Grafana
- –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ (30 –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è)
- –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (CPU, RAM, response time)
- Fallback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–õ–æ–≥–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å—Ç–µ–∫–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- **Filebeat** - —Å–±–æ—Ä –ª–æ–≥–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤ (–≤–º–µ—Å—Ç–æ Promtail)
- **Elasticsearch** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ª–æ–≥–æ–≤ (–≤–º–µ—Å—Ç–æ Loki)
- **Kibana** - –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ –∞–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤
- **Grafana** - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –∏ –¥–∞—à–±–æ—Ä–¥—ã

JSON —Ñ–æ—Ä–º–∞—Ç –±—ã–ª –≤–Ω–µ–¥—Ä—ë–Ω –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –ª–æ–≥–æ–≤ –≤ Grafana. –î–æ —ç—Ç–æ–≥–æ –ª–æ–≥–∏ –±—ã–ª–∏ –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏, —á—Ç–æ –¥–µ–ª–∞–ª–æ –ø–∞—Ä—Å–∏–Ω–≥ –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã–º.

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### üîß –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `env.app_mode` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã. –†–µ–∂–∏–º—ã –≤–ª–∏—è—é—Ç –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ö–æ—Å—Ç-–ø–æ—Ä—Ç –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ —Ç.–¥.):
- `prod` - –ø—Ä–æ–¥–∞–∫—à–Ω —Ä–µ–∂–∏–º
- `local` - –ª–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
- `docker` - –∑–∞–ø—É—Å–∫ –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–∂–∏–º–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `core/config_dir/env_modes.py`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `core/config_dir/config.py` –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º.

### üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤

–õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `WORKDIR/logs/`, –≥–¥–µ `WORKDIR` - –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞. –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–¥—É–ª—è —á–µ—Ä–µ–∑ `create_log_dirs()`.

### üé® –§–æ—Ä–º–∞—Ç—Ç–µ—Ä—ã

**1. –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä (default)**

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `colorlog.ColoredFormatter` –¥–ª—è —Ü–≤–µ—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª:

```
%(log_color)s%(levelname)-8s%(reset)s | 
\033[32mD%(asctime)s\033[0m | 
\033[34m%(method)s\033[0m \033[36m%(url)s\033[0m | 
%(cyan)s%(location)s:%(reset)s def %(cyan)s%(func)s%(reset)s(): line - %(cyan)s%(line)d%(reset)s - \033[34m%(ip)s\033[0m 
%(message)s
```

–¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **–ó–µ–ª—ë–Ω—ã–π** - –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
- **–°–∏–Ω–∏–π** - HTTP –º–µ—Ç–æ–¥ –∏ URL
- **Cyan** - location (—Ñ–∞–π–ª), —Ñ—É–Ω–∫—Ü–∏—è, –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏
- **–°–∏–Ω–∏–π** - IP –∞–¥—Ä–µ—Å
- **–¶–≤–µ—Ç —É—Ä–æ–≤–Ω—è** - DEBUG (–±–µ–ª—ã–π), INFO (–∑–µ–ª—ë–Ω—ã–π), WARNING (–∂—ë–ª—Ç—ã–π), ERROR (–∫—Ä–∞—Å–Ω—ã–π), CRITICAL (–∂–∏—Ä–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π)

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ - –ø—Ä–∏—è—Ç–Ω–µ–µ —á–∏—Ç–∞—Ç—å, —á–µ–º –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã–µ –±—É–∫–≤—ã.

**2. JSON —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä**

–°–æ–∑–¥–∞—ë—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON –ª–æ–≥–∏ –¥–ª—è Elasticsearch:

```json
{
  "@timestamp": "2024-03-15T10:30:45.123456Z",
  "level": "INFO",
  "message": "–°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ä—Å–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è",
  "service": "fastapi-app",
  "environment": "prod",
  "method": "POST",
  "url": "/private/n8n_ui/ttable/create",
  "func": "create_ttable",
  "location": "core/api/n8n_ui/main_ui.py",
  "line": 42,
  "ip": "192.168.1.100",
  "http_status": 200,
  "response_time": 0.125,
  "cpu_percent": 45.2,
  "memory_percent": 62.8,
  "memory_used_mb": 512,
  "memory_total_mb": 1024,
  "metric_type": "http_request"
}
```

–ü–æ–ª—è:
- `@timestamp` - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –≤ ISO 8601 —Ñ–æ—Ä–º–∞—Ç–µ (UTC)
- `level` - —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- `message` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- `service` - –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ (fastapi-app)
- `environment` - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã (prod/local/docker)
- `method` - HTTP –º–µ—Ç–æ–¥ (GET, POST, PUT, DELETE)
- `url` - –ø—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞
- `func` - –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –≤—ã–∑–≤–∞–Ω –ª–æ–≥
- `location` - –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
- `line` - –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤—ã–∑–æ–≤–∞
- `ip` - IP –∞–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞
- `http_status` - HTTP —Å—Ç–∞—Ç—É—Å –∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `response_time` - –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `cpu_percent` - –∑–∞–≥—Ä—É–∑–∫–∞ CPU –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `memory_percent` - –∑–∞–≥—Ä—É–∑–∫–∞ RAM –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `memory_used_mb` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –≤ –ú–ë (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `memory_total_mb` - –æ–±—â–∞—è –ø–∞–º—è—Ç—å –≤ –ú–ë (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `metric_type` - —Ç–∏–ø –º–µ—Ç—Ä–∏–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:**

–ï—Å–ª–∏ JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±—ä–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∞–π—Ç—ã), —Å–æ–∑–¥–∞—ë—Ç—Å—è —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ª–æ–≥ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ:

```json
{
  "@timestamp": "2024-03-15T10:30:45.123456Z",
  "level": "ERROR",
  "message": "Original message",
  "service": "fastapi-app",
  "error": "JSON serialization failed: Object of type bytes is not JSON serializable"
}
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ª–æ–≥ –Ω–µ –ø—Ä–æ–ø–∞–¥—ë—Ç –±–µ—Å—Å–ª–µ–¥–Ω–æ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

### üì§ Handlers (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)

**1. üñ•Ô∏è Console Handler**
- –í—ã–≤–æ–¥ –≤ stdout (—Ç–µ—Ä–º–∏–Ω–∞–ª)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ü–≤–µ—Ç–Ω–æ–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä
- –£—Ä–æ–≤–µ–Ω—å: DEBUG (–≤—Å–µ –ª–æ–≥–∏)

**2. üíæ JSON File Handler**
- –ö–ª–∞—Å—Å: `TimedRotatingFileHandler`
- –§–∞–π–ª: `WORKDIR/logs/app.log`
- –†–æ—Ç–∞—Ü–∏—è: –∫–∞–∂–¥—É—é –ø–æ–ª–Ω–æ—á—å (`when="midnight"`)
- –•—Ä–∞–Ω–µ–Ω–∏–µ: 30 –±—ç–∫–∞–ø–æ–≤ (30 –¥–Ω–µ–π)
- –ö–æ–¥–∏—Ä–æ–≤–∫–∞: UTF-8
- –£—Ä–æ–≤–µ–Ω—å: DEBUG (–≤—Å–µ –ª–æ–≥–∏)

–õ–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è 30 –¥–Ω–µ–π –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π. –í Elasticsearch –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ ILM (Index Lifecycle Management) –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞–º–∏ –ª–æ–≥–æ–≤.

### üìä –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–ú–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ Python logging:

| –£—Ä–æ–≤–µ–Ω—å | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|---------|----------|-------------------|
| DEBUG | 10 | –ü—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ |
| INFO | 20 | –î–ª—è –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ (–¥–µ—Ñ–æ–ª—Ç). –û–±—ã—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |
| WARNING | 30 | Edge cases - –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏, –Ω–µ —è–≤–ª—è—é—â–∏–µ—Å—è –æ—à–∏–±–∫–∞–º–∏ |
| ERROR | 40 | –í—ã—Ö–æ–¥ –∑–∞ —Ä–∞–º–∫–∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏, –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ |
| CRITICAL | 50 | –û–ø–∞—Å–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ |

–≠—Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ö–æ—Ä–æ—à–µ–π –¥–ª—è –ø–æ–≤—Å–µ–º–µ—Å—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ.

## üîß –§—É–Ω–∫—Ü–∏–∏

### üìù log_event(event, *args, request=None, level='INFO', **extra)

**–°–∏–≥–Ω–∞—Ç—É—Ä–∞:** 
```python
def log_event(
    event: Any, 
    *args, 
    request: Request | WebSocket = None, 
    level: Literal['DEBUG','INFO','WARNING','ERROR','CRITICAL'] = 'INFO', 
    **extra
) -> None
```

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–∑–æ–≤–∞ (—Ñ–∞–π–ª, —Ñ—É–Ω–∫—Ü–∏—è, —Å—Ç—Ä–æ–∫–∞) –∏ –æ–±–æ–≥–∞—â–∞–µ—Ç –ª–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ HTTP –∑–∞–ø—Ä–æ—Å–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `event` (Any): –°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç–∏–ª–µ `%` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"User %s logged in"`)
- `*args` (tuple): –ê—Ä–≥—É–º–µ–Ω—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `%` —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
- `request` (Request | WebSocket | None): –û–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –º–µ—Ç–æ–¥–∞, URL –∏ IP. –ú–æ–∂–µ—Ç –±—ã—Ç—å `None` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ HTTP (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, startup events)
- `level` (Literal): –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `'INFO'`
- `**extra` (dict): –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è JSON –ª–æ–≥–∞ (–º–µ—Ç—Ä–∏–∫–∏, –∫–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `None`

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–∑–æ–≤–∞:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `inspect.currentframe()` –∏ `inspect.getouterframes()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–∑—ã–≤–∞—é—â–µ–º –∫–æ–¥–µ
   - –ò–∑–≤–ª–µ–∫–∞–µ—Ç: –∏–º—è —Ñ–∞–π–ª–∞ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å), –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏
   - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é –∏ —É–ø—Ä–æ—â–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É –±–∞–≥–æ–≤

2. **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø—Ä–æ—Å–µ:**
   - –ï—Å–ª–∏ `request` - —ç—Ç–æ `Request`: –∏–∑–≤–ª–µ–∫–∞–µ—Ç HTTP –º–µ—Ç–æ–¥, URL –ø—É—Ç—å, IP –∞–¥—Ä–µ—Å
   - –ï—Å–ª–∏ `request` - —ç—Ç–æ `WebSocket`: –∏–∑–≤–ª–µ–∫–∞–µ—Ç URL –ø—É—Ç—å, IP –∞–¥—Ä–µ—Å
   - –ï—Å–ª–∏ `request` - `None`: –ø–æ–ª—è –æ—Å—Ç–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è IP:**
   - –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `request.state.client_ip` (–µ—Å–ª–∏ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ middleware)
   - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤—ã–∑—ã–≤–∞–µ—Ç `get_client_ip(request)` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   - –≠—Ç–æ –ø–æ–≥–æ–Ω—è –∑–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é - –∑–∞—á–µ–º –ª–∏—à–Ω–∏–π —Ä–∞–∑ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–æ, —á—Ç–æ —É–∂–µ –µ—Å—Ç—å?

4. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã `*args` - –ø—Ä–∏–º–µ–Ω—è–µ—Ç `%` —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: `event % args`
   - –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `event` –∫–∞–∫ –µ—Å—Ç—å

5. **–ó–∞–ø–∏—Å—å –ª–æ–≥–∞:**
   - –í—ã–∑—ã–≤–∞–µ—Ç `logger.log()` —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —É—Ä–æ–≤–Ω–µ–º
   - –ü–µ—Ä–µ–¥–∞—ë—Ç –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `extra` —Å–ª–æ–≤–∞—Ä—å
   - –î–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –æ–±–∞ handler'–∞ (–∫–æ–Ω—Å–æ–ª—å –∏ JSON —Ñ–∞–π–ª)

**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```python
from core.utils.logger import log_event
from starlette.requests import Request

# –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
log_event("Application started")

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º HTTP –∑–∞–ø—Ä–æ—Å–∞
@router.post("/create")
async def create_ttable(request: Request):
    ttable_id = await db.ttable.create(...)
    log_event(
        f"–°–æ–∑–¥–∞–Ω–∞ –≤–µ—Ä—Å–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è | ttable_id: {ttable_id}",
        request=request
    )
    return {"ttable_id": ttable_id}

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
log_event(
    "User %s created timetable %d in building %d",
    user_id, ttable_id, building_id,
    request=request
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —É—Ä–æ–≤–Ω–µ–º WARNING
log_event(
    f"–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ | diff_groups: {len(diff_groups)}",
    request=request,
    level='WARNING'
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏
try:
    result = await dangerous_operation()
except Exception as e:
    log_event(
        f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏: {str(e)}",
        request=request,
        level='ERROR'
    )
    raise

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ (–∏–∑ middleware)
log_event(
    f"Request completed",
    request=request,
    http_status=200,
    response_time=0.125,
    cpu_percent=45.2,
    memory_percent=62.8,
    memory_used_mb=512,
    memory_total_mb=1024,
    metric_type='http_request'
)
```

## üèóÔ∏è –ö–ª–∞—Å—Å—ã

### üìã JSONFormatter

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö JSON –ª–æ–≥–æ–≤, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö —Å Elasticsearch –∏ Grafana.

**–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ:** `logging.Formatter`

**–ú–µ—Ç–æ–¥—ã:**

#### format(record)

**–°–∏–≥–Ω–∞—Ç—É—Ä–∞:** `def format(self, record: logging.LogRecord) -> str`

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç LogRecord –≤ JSON —Å—Ç—Ä–æ–∫—É —Å –ø–æ–ª—è–º–∏ –¥–ª—è EFK Stack.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `record` (logging.LogRecord): –ó–∞–ø–∏—Å—å –ª–æ–≥–∞ –∏–∑ Python logging

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** 
- `str`: JSON —Å—Ç—Ä–æ–∫–∞ —Å –ø–æ–ª—è–º–∏ –ª–æ–≥–∞

**–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞:**

1. –°–æ–∑–¥–∞—ë—Ç –±–∞–∑–æ–≤—ã–π —Å–ª–æ–≤–∞—Ä—å —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏:
   - `@timestamp` - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ UTC —Å ISO 8601 —Ñ–æ—Ä–º–∞—Ç–æ–º
   - `level` - —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   - `message` - —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
   - `service` - –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ (fastapi-app)
   - `environment` - —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –∏–∑ `env.app_mode`
   - `method`, `url`, `func`, `location`, `line`, `ip` - –∏–∑ extra –ø–æ–ª–µ–π

2. –î–æ–±–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ `record.__dict__`:
   - –ú–µ—Ç—Ä–∏–∫–∏: `http_status`, `response_time`, `cpu_percent`, `memory_percent`
   - –†–µ—Å—É—Ä—Å—ã: `memory_used_mb`, `memory_total_mb`
   - –¢–∏–ø: `metric_type`
   - –ë–µ—Ä—ë—Ç –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ `__dict__` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ (—á–∏—Å–ª–∞ –æ—Å—Ç–∞—é—Ç—Å—è —á–∏—Å–ª–∞–º–∏)

3. –°–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –≤ JSON:
   - `ensure_ascii=False` - –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
   - –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞—ë—Ç fallback –ª–æ–≥ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ

**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
- –ü–æ–ª—è –∏–∑ `extra` –±–µ—Ä—É—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ `__dict__` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –ß–∏—Å–ª–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è —á–∏—Å–ª–∞–º–∏ (–Ω–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫–∏)
- –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–π –≤ Elasticsearch –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤ Grafana

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

### üåê –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- `logging` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Python –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- `logging.config.dictConfig` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–æ–≥–≥–µ—Ä–∞ —á–µ—Ä–µ–∑ —Å–ª–æ–≤–∞—Ä—å
- `colorlog` - —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
- `inspect` - –∏–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—ã–∑–æ–≤–∞
- `json` - —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ JSON —Ñ–æ—Ä–º–∞—Ç
- `pathlib.Path` - —Ä–∞–±–æ—Ç–∞ —Å –ø—É—Ç—è–º–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
- `datetime` - —Ä–∞–±–æ—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏

### üîó –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–æ–¥—É–ª–∏
- `core.config_dir.config` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
  - `WORKDIR` - –∫–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞
  - `env` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è (app_mode)
- `core.utils.anything` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
  - `create_log_dirs()` - —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
  - `get_client_ip()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ IP –∞–¥—Ä–µ—Å–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
- `starlette.requests.Request` - –æ–±—ä–µ–∫—Ç HTTP –∑–∞–ø—Ä–æ—Å–∞
- `starlette.websockets.WebSocket` - –æ–±—ä–µ–∫—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å middleware

–ú–æ–¥—É–ª—å —Ç–µ—Å–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å `core/api/middleware.py::ASGILoggingMiddleware`, –∫–æ—Ç–æ—Ä–∞—è:
- –ó–∞–º–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- –°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ CPU –∏ RAM
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `request.state.client_ip` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ü–µ—Ä–µ–¥–∞—ë—Ç –º–µ—Ç—Ä–∏–∫–∏ –≤ `log_event()` —á–µ—Ä–µ–∑ `**extra`

–ü—Ä–∏–º–µ—Ä –∏–∑ middleware:

```python
log_event(
    f"Request completed",
    request=request,
    http_status=response.status_code,
    response_time=elapsed_time,
    cpu_percent=cpu_usage,
    memory_percent=memory_percent,
    memory_used_mb=memory_used,
    memory_total_mb=memory_total,
    metric_type='http_request'
)
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏ –∫–∞–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –º–µ—Ç—Ä–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –¢–µ–∫—É—â–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å CPU –∏ RAM –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å web app.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:** –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ —á–µ—Ä–µ–∑ –ª–æ–≥–∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω –≤–≤–∏–¥—É –ø—Ä–æ—Å—Ç–æ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –í –±—É–¥—É—â–µ–º –≤–æ–∑–º–æ–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –≤–Ω–µ Docker —Å—Ä–µ–¥—ã.

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### üö® –û—à–∏–±–∫–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ JSON

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–±—ä–µ–∫—Ç—ã Python –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ JSON (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–∞–π—Ç—ã, datetime –±–µ–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏, –∫–∞—Å—Ç–æ–º–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã).

**–†–µ—à–µ–Ω–∏–µ:** JSONFormatter —Å–æ–¥–µ—Ä–∂–∏—Ç try-except –±–ª–æ–∫:

```python
try:
    return json.dumps(log_entry, ensure_ascii=False)
except (TypeError, ValueError) as e:
    fallback_entry = {
        "@timestamp": datetime.now(UTC).isoformat() + "Z",
        "level": record.levelname,
        "message": str(record.getMessage()),
        "service": "fastapi-app",
        "error": f"JSON serialization failed: {str(e)}"
    }
    return json.dumps(fallback_entry, ensure_ascii=False)
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ª–æ–≥ –Ω–µ –ø—Ä–æ–ø–∞–¥—ë—Ç –±–µ—Å—Å–ª–µ–¥–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å.

### ‚ùì –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ request

–§—É–Ω–∫—Ü–∏—è `log_event()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ–±—ä–µ–∫—Ç–∞ `request`:

```python
log_event("Background task started")  # request=None
```

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø–æ–ª—è `method`, `url`, `ip` –æ—Å—Ç–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏ –≤ JSON –ª–æ–≥–µ.

### üåê –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ client_ip –≤ state

–ï—Å–ª–∏ `request.state.client_ip` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è middleware), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback:

```python
ip = request.state.client_ip if hasattr(request.state, 'client_ip') else get_client_ip(request)
```

–§—É–Ω–∫—Ü–∏—è `get_client_ip()` –∏–∑–≤–ª–µ–∫–∞–µ—Ç IP –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-Forwarded-For` —Å —É—á—ë—Ç–æ–º –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏.

## üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### üé® –¶–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏

–¶–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ø—Ä–æ—â–∞–µ—Ç —á—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:
- –ë—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ—à–∏–±–∫–∏ (–∫—Ä–∞—Å–Ω—ã–π —Ü–≤–µ—Ç)
- –û—Ç–ª–∏—á–∞—Ç—å —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –í–∏–¥–µ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ª–æ–≥–∞ (–º–µ—Ç–æ–¥, URL, —Ñ—É–Ω–∫—Ü–∏—è)
- –ü—Ä–∏—è—Ç–Ω–µ–µ –¥–ª—è –≥–ª–∞–∑, —á–µ–º –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç

### üîç –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `inspect` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Å—Ç—Ä–æ–∫–∏:
- –£–ø—Ä–æ—â–∞–µ—Ç –≤—ã–∑–æ–≤ `log_event()` - –Ω–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å - –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Å—Ç—É –≤—ã–∑–æ–≤–∞
- –£–ø—Ä–æ—â–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É - —Å—Ä–∞–∑—É –≤–∏–¥–Ω–æ, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à—ë–ª –ª–æ–≥

### üìà –ú–µ—Ç—Ä–∏–∫–∏ —á–µ—Ä–µ–∑ –ª–æ–≥–∏

–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–≥–∏ –∫–∞–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –º–µ—Ç—Ä–∏–∫:

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ
- –ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –ª–æ–≥–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ú–µ—Ç—Ä–∏–∫–∏ —Å–º–µ—à–∞–Ω—ã —Å –ª–æ–≥–∞–º–∏
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ—Å—Ç—å
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ë—É–¥—É—â–µ–µ:** –í–æ–∑–º–æ–∂–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ (Prometheus, StatsD) –≤–Ω–µ Docker —Å—Ä–µ–¥—ã –¥–ª—è –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

### üîÑ –†–æ—Ç–∞—Ü–∏—è –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ

- **–§–∞–π–ª–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è:** 30 –¥–Ω–µ–π –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
- **Elasticsearch ILM:** –û—Ç–¥–µ–ª—å–Ω–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞–º–∏
- **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:** –õ–æ–≥–∏ –≤ —Ñ–∞–π–ª–∞—Ö —Å–ª—É–∂–∞—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–µ–π –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å Elasticsearch

### ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `request.state.client_ip` –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º `get_client_ip()`
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π (`os.path.relpath`) –≤–º–µ—Å—Ç–æ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö
- –õ–µ–Ω–∏–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å `*args`)
- –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ `__dict__` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–∏—à–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤

## üíª –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üìå –ë–∞–∑–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
from core.utils.logger import log_event

# –ü—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
log_event("Application started successfully")

# –° —É—Ä–æ–≤–Ω–µ–º
log_event("Configuration loaded", level='DEBUG')
log_event("Deprecated API used", level='WARNING')
log_event("Database connection failed", level='ERROR')
log_event("Out of memory", level='CRITICAL')
```

### üåê –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö

```python
from fastapi import APIRouter, Request
from core.utils.logger import log_event

router = APIRouter()

@router.post("/create")
async def create_resource(request: Request, data: CreateSchema):
    log_event(
        f"Creating resource | type: {data.type}",
        request=request
    )
    
    try:
        resource_id = await db.create(data)
        log_event(
            f"Resource created | id: {resource_id}",
            request=request
        )
        return {"id": resource_id}
    except Exception as e:
        log_event(
            f"Failed to create resource: {str(e)}",
            request=request,
            level='ERROR'
        )
        raise
```

### üî§ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

```python
# –°—Ç–∞—Ä—ã–π —Å—Ç–∏–ª—å % —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
log_event(
    "User %s performed action %s on resource %d",
    user_id, action, resource_id,
    request=request
)

# –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å f-string (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
log_event(
    f"User {user_id} performed {action} on resource {resource_id}",
    request=request
)
```

### üìä –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –º–µ—Ç—Ä–∏–∫–∞–º–∏ (–∏–∑ middleware)

```python
import time
import psutil

start_time = time.time()

# ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ...

elapsed_time = time.time() - start_time
cpu_usage = psutil.cpu_percent()
memory = psutil.virtual_memory()

log_event(
    "Request processed",
    request=request,
    http_status=200,
    response_time=elapsed_time,
    cpu_percent=cpu_usage,
    memory_percent=memory.percent,
    memory_used_mb=memory.used / 1024 / 1024,
    memory_total_mb=memory.total / 1024 / 1024,
    metric_type='http_request'
)
```

### ‚è∞ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á

```python
async def background_cleanup():
    log_event("Starting cleanup task")
    
    deleted_count = await cleanup_old_records()
    
    log_event(
        f"Cleanup completed | deleted: {deleted_count} records",
        level='INFO'
    )
```

### üé® –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–≤—ã–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ANSI escape codes –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
log_event(
    f"Version switched | pending: \033[33m{pending_id}\033[0m -> active: \033[32m{active_id}\033[0m",
    request=request
)

# –¶–≤–µ—Ç–∞:
# \033[31m - –∫—Ä–∞—Å–Ω—ã–π
# \033[32m - –∑–µ–ª—ë–Ω—ã–π
# \033[33m - –∂—ë–ª—Ç—ã–π
# \033[34m - —Å–∏–Ω–∏–π
# \033[35m - magenta
# \033[36m - cyan
# \033[0m - —Å–±—Ä–æ—Å —Ü–≤–µ—Ç–∞
```
